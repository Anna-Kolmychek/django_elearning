# Проект "Платформа онлайн-обучения"

## Запуск проекта через docker-compose

1. Скопируйте проект


2. Создайте файл `.env` и запишите в него (пример структуры файла в `.env_sample`)
- STRIPE_API_KEY (для оплаты в ДЗ 26.1)
- EMAIL_HOST_USER (для отправки писем в ДЗ 26.2)
- EMAIL_HOST_PASSWORD (для отправки писем в ДЗ 26.2)

3. В `settings.py` измените настройки почты при необходимости (хост и пароль заданы в `.env` (см. п.5),
остальные настройки приведены для яндекса.
```
EMAIL_HOST = 'smtp.yandex.ru'
EMAIL_PORT = 465
EMAIL_USE_SSL = True
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD')
```
 
4. Запустите сборку
```
docker-compose build
```
5. Запустите приложение
```
docker-compose up
```

6. При желании создайте суперпользователя (admin@email.com, 12345),
группу модераторов, пользователя модератор (moderator@email.com, 12345) и тестовые данные:
двух тестовых пользователей (user1@email.com/user2@email.com, 12345), курсы, уроки, платежи.
Последовательность и наличие всех команд принципиально.
```
docker-compose exec app python3 manage.py create_su
docker-compose exec app python3 manage.py create_moderator_group
docker-compose exec app python3 manage.py create_moderator
docker-compose exec app python3 manage.py create_test_users
docker-compose exec app python3 manage.py loaddata data_education_test.json
docker-compose exec app python3 manage.py create_test_payments
```


## Запуск проекта локально (без docker)

1. Скопируйте проект, установите виртуальное окружение и зависимости из `requirements.txt`.

2. В файле `config/settings.py` при необходимости измените настройки базы данных. 
В проекте используется локальный `postgresql`, база с именем `django_elearning`, 
пользователь `postgres` с входом для локального подключения без пароля
```
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'django_elearning',
        'USER': 'postgres',
    }
}
```

3. Создайте пустую базу данных с именем `django_elearning` (при локольном входе в `postgresql` без пароля):
```
psql -U postgres
create database django_elearning;
\q
```

4. Примените миграции
```
python3 manage.py migrate
```

5. Создайте файл `.env` и запишите в него (пример структуры файла в `.env_sample`)
- STRIPE_API_KEY (для оплаты в ДЗ 26.1)
- EMAIL_HOST_USER (для отправки писем в ДЗ 26.2)
- EMAIL_HOST_PASSWORD (для отправки писем в ДЗ 26.2)

6. В `settings.py` измените настройки почты при необходимости (хост и пароль заданы в `.env` (см. п.5),
остальные настройки приведены для яндекса.
```
EMAIL_HOST = 'smtp.yandex.ru'
EMAIL_PORT = 465
EMAIL_USE_SSL = True
EMAIL_HOST_USER = os.getenv('EMAIL_HOST_USER')
EMAIL_HOST_PASSWORD = os.getenv('EMAIL_HOST_PASSWORD')
```
7. При желании создайте суперпользователя (admin@email.com, 12345),
группу модераторов, пользователя модератор (moderator@email.com, 12345) и тестовые данные:
двух тестовых пользователей (user1@email.com/user2@email.com, 12345), курсы, уроки, платежи.
Последовательность и наличие всех команд принципиально.
```
python3 manage.py create_su
python3 manage.py create_moderator_group
python3 manage.py create_moderator
python3 manage.py create_test_users
python3 manage.py loaddata data_education_test.json
python3 manage.py create_test_payments
```

8. Запустите сервер
```
python3 manage.py runserver
```

9. Запустите celery для отложенных и периодических задач
```
celery -A config worker -l INFO
celery -A config beat -l INFO -S django
```


## ДЗ 27.2 Docker Compose

- Подготовлен Dockerfile для запуска контейнера с проектом.
- Подготовлен docker-compose.yaml для запуска проекта с учетом
  - postgres
  - redis
  - celery, celery-beat


## Сделано ранее

## ДЗ 26.2 Celery

- Выполнена настройка проекта для работы с celery (в качестве брокера используется redis) и celery-beat
- Реализована рассылка писем пользователям, подписанным на курс, при обновлении материалов курса
(самого курса или входящих в него уроков). Рассылка реализованна через отложенные задачи.
- Реализована проверка "неактивных" пользователей: если пользователь не логинился больше 30 дней,
он блокируется через флаг is_active. Проверка реализована периодической задачей.


### ДЗ 26.1 Документирование и безопасность

- Добавлена возможность оплаты через API STRIPE и проверка платежей
  - Изменена модель Payments под оплату через stripe (убраны лишние поля, добавлены поле с id сессии и статусом оплаты).
  - Доработан эндпоинт создания платежа, в т.ч. добавлена автоматическая подстановка пользователя.
  - Доработан эндпоинт вывода списка платежей: в момент перехода к списку происходит проверка неоплаченных платежей.

- Подключена автоматическая генерация документации через drf-yasg

### ДЗ 25.2 Валидаторы, пагинация и тест

- Для уроков и курсов добавлена проверка на отсутствие ссылок, кроме ссылок на youtube

- Добавлено приложение subscriptions, модель подписок (пользователь-курс), эндпоинты для создания и удаления подписок

- В курсах отображается флаг: есть или нет подписки у пользователя на курс

- Добавлена пагинация для курсов и уроков

- Добавлены тесты для CRUD уроков

- Добавлены тесты для подписок (созадние/удаление/отображение в курсе)


### ДЗ 25.1 Права доступа в DRF

- Добавлена jwt-авторизация

- Все эндпоинты закрыты для неавторизованных пользователей (за исключением создания пользователя)

- Добавлена группа модераторов (кастомная команда create_moderator_group) 
и пользователь-модератор (кастомная команда create_moderator)

- Для курсов и уроков доступ ограничен следующим образом:
  - Создание: модератор не может создавать новую запись. Авторизованный пользователь, но не модератор, может создавать запись.
  - Просмотр: модератор может видеть все записи, пользователь только свои
  - Редактирование: модератор может редактировать все записи, пользователь только свои
  - Удаление: модератор не может удалить никакую запись. Авторизованный пользователь, 
  но не модератор, может удалить только свою запись.

- Для эндпоинтов пользователей:
  - Авторизованные пользователи могут просматривать любой профиль, но без пароля, платежей и фамилии. В общем списке (list)
  также выводятся сокращенные профили.
  - Просмотр свего профиля (retrieve) доступен в полном объеме 


### ДЗ 24.2 Сериализаторы

- Для модели курса в сериализатор добавлено 
  - вывод количества уроков в курсе
  - вывод списка уроков курса

- Добавлена кастомная команда для создания суперпользователя

- Создано новое приложение payments
  - описана модель по ТЗ
  - создана кастомная команда для тестовой записи платежей в БД (!!! для корректной работы
  в БД должен быть мимиум 1 пользователь, 1 урок и 1 курс !!!)
  - реализован CRUD через ViewSet
  - настроена фильтрация списка платежей с возможностями
    - менять порядок сортировки по дате оплаты
    - фильтровать по курсу или уроку
    - фильтровать по способу оплаты

- Для пользователя сделан вывод истории платежей


### ДЗ 24.1 Вьюсеты и дженерики

- Создан gjango-проект, подчключен DRF

- Созданы приложения
  - users
  - eductaion

- Созданы модели
  - User (авторизация по email, расширено полями phone, city, photo) - в приложении users
  - Course - в приложении eductaion
  - Lesson - в приложении eductaion

- Реализован CRUD для модели Course через ViewSet

- Реализован CRUD для модели Lesson через Generic-классы

- Реализован CRUD для модели User через ViewSet 

